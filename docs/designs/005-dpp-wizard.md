# Design Doc 005: DPP Wizard MVP

This document outlines the sub-roadmap for Task #5, the development of a client-side web-based wizard to generate a valid DPP JSON file.

---

- **[IN PROGRESS] 5. DPP Wizard MVP:** Develop a client-side web-based wizard to generate a valid DPP JSON file, serving as a proof-of-concept for stakeholders. Pause and allow the user to test and discuss next steps.
  - **[COMPLETED] 5a. Architecture & Setup:** Create `src/wizard/` containing `index.html`, `wizard.css`, and `wizard.js`. Configure `index.html` to link to the shared branding CSS at `../../branding/css/keystone-style.css`. Ensure the build process deploys this directory to `dist/spec/wizard/`.
  - **[COMPLETED] 5b. Sector Selection:** Implement UI in `index.html` and logic in `wizard.js` to handle sector selection.
  - **[COMPLETED] 5c. Dynamic Form Generation:** Create `src/wizard/schema-loader.js` to fetch JSON schemas from the relative path `../validation/v1/json-schema/`. Create `src/wizard/form-builder.js` to dynamically generate HTML form inputs based on the loaded schema definitions.
  - **[COMPLETED] 5d. Voluntary Information:** Implement logic in `wizard.js` to add dynamic name-value pair fields to the UI.
  - **[COMPLETED] 5e. JSON Generation:** Create `src/wizard/dpp-generator.js` to scrape the generated form data from the DOM and construct the final DPP JSON object.
  - **[COMPLETED] 5f. Unit Testing:** Create `testing/unit/wizard.test.js` using Jest and JSDOM. Test `form-builder.js` by passing mock schemas and asserting HTML output. Test `dpp-generator.js` by populating a virtual DOM and asserting the resulting JSON.
  - **[COMPLETED] 5g. Integration Testing:** Create `testing/integration/wizard-flow.test.js` to simulate a full user session. Mock the schema `fetch` calls, programmatically fill the virtual form, trigger generation, and validate the output JSON against the official `dpp.schema.json` using Ajv.
  - **[COMPLETED] 5h. Initial Core DPP Form:** On load, display a form for core DPP fields based on `dpp.schema.json`.
  - **[COMPLETED] 5i. Stabilize UI Test Runner:** Set up and stabilized the Playwright UI integration test runner, which was essential for debugging the form generation logic. This involved fixing timeouts and incorrect selectors in the spec files (`testing/integration/playwright/`) and ensuring the test commands in `testing/package.json` ran correctly.
  - **[COMPLETED] 5j. Improve Wizard UI Test Coverage:** Before implementing new features, increase the robustness and coverage of the Playwright UI tests to ensure the current form generation works correctly across all sectors. Pause and allow the user to test and discuss next steps.
    - **[COMPLETED] 5j-1. Consolidate and Parameterize Tests:** Refactor the two separate test files (`wizard.spec.js`, `wizard-construction.spec.js`) into a single `wizard.spec.js`. This test will be parameterized to loop through all available sectors: `['battery', 'construction', 'electronics', 'textile']`. Pause and allow the user to test and discuss next steps.
    - **[COMPLETED] 5j-2. Add Sector-Specific Assertions:** Within the parameterized test, add specific `expect` assertions to verify that a unique and representative field for each sector is correctly rendered. Pause and allow the user to test and discuss next steps.
    - **[COMPLETED] 5j-3. Add Sector Switching Stress Test:** Create a new test case that simulates a user selecting different sectors one after another to test for race conditions or state management issues ("flaky sector loading"). Pause and allow the user to test and discuss next steps.
  - **[COMPLETED] 5k. Fully Support Nested Object Display:** Debug the client-side `form-builder.js` to ensure that fully resolved nested objects (like EPD) are correctly rendered as dot-separated input fields in the browser, fixing the '[object]' UI bug.
  - **[COMPLETED] 5l. Display `rdfs:label` in Ontology Column:** Modify the form builder to display the `rdfs:label` from the ontology in the third column, providing a more human-readable name for each field. Pause and allow the user to test and discuss next steps.
  - **[COMPLETED] 5m. Refine Ontology Column UI:** Refactor the form builder to display the `rdfs:comment` in a tooltip icon in a new, fourth column.
    - **[COMPLETED] 5m-1. Update Unit Test:** In `testing/unit/wizard.test.js`, modify the assertions to expect a 4-column grid layout. The test will check for the tooltip button in the new fourth column and verify its `title` attribute contains the comment. This test will fail. Pause and allow the user to test and discuss next steps.
    - **[COMPLETED] 5m-2. Update CSS and Form Builder:** In `wizard.css`, change the grid to four columns and add styling for the tooltip button. In `form-builder.js`, update the logic to create the fourth column and place the styled tooltip button within it. This should make the unit test pass. Pause and allow the user to test and discuss next steps.
    - **[COMPLETED] 5m-3. Update Integration Test:** In `testing/integration/playwright/wizard.spec.js`, update the assertions to reflect the new 4-column structure, verifying the tooltip button and its content in a full browser environment. Pause and allow the user to test and discuss next steps.
  - **[COMPLETED] 5n. Improve Array UX:** Revisit and improve the user experience for array input fields based on user feedback.
    - **[COMPLETED] 5n-1. Add Failing Unit Test for Object Arrays:** In `testing/unit/wizard.test.js`, add a new test case with a schema containing an array of objects. Assert that clicking "Add" creates a nested sub-form, not a simple input. This test will fail. Pause and allow the user to test and discuss next steps.
    - **[CANCELLED] 5n-2. Implement Nested Array Logic:** In `form-builder.js`, refactor the array handler to detect when the `items` property is an object. It should then recursively call the `generateRows` function to build a sub-form for the object's properties. Also, wrap the array UI in a `<fieldset>` for better visual grouping. This should make the unit test pass. *(Note: The recursive generation was implemented, but the `<fieldset>` approach was superseded by a user-preferred lightweight layout that reused the main grid.)*
    - **[COMPLETED] 5n-3. Add Integration Test for Object Arrays:** In `testing/integration/playwright/wizard.spec.js`, update the test for the `battery` sector to assert that the complex `documents` array renders its nested fields correctly.
    - **[COMPLETED] 5n-4. Fix Add Button After Item Removal:** Test and fix the bug where the 'Add Item' button stops working after an array item has been deleted, due to an invalid DOM reference.
    - **[COMPLETED] 5n-5. Implement Re-indexing on Remove:** Test and implement the re-indexing of array items in the UI (e.g., changing `item.2` to `item.1`) when a preceding item is deleted. This ensures the final generated JSON does not have gaps in the array.
    - **[COMPLETED] 5n-6. Add Granular Tests for Array UX:** Added a comprehensive suite of unit tests to cover layout, addition, removal, and re-indexing for both primitive and object arrays to prevent regressions.
    - **[COMPLETED] 5n-7. Test Deeply Nested Arrays:** Added a unit test to verify that arrays within objects within arrays (a-in-o-in-a) render and re-index correctly.
    - **[COMPLETED] 5n-8. Fix Stale Remove Button Bug:** Fixed a bug where remove buttons on object array items would fail after a preceding item was removed and re-indexed, due to a stale closure in the event listener.
  - **[IN PROGRESS] 5o. Wizard Bug Bash:** Address a series of identified bugs and design gaps to improve wizard stability and correctness.
    - **See Design Doc:** [docs/designs/wizard-bug-bash.md](./wizard-bug-bash.md)
  - **[PENDING] 5p. Custom Field Implementation:** Implement the 'Add Custom Field' button to add a row for Name, Value, and Units. Pause and allow the user to test and discuss next steps.
  - **[PENDING] 5q. Custom Field Validation:** Add validation to ensure the 'Name' in custom fields is in camelCase format. Pause and allow the user to test and discuss next steps.
  - **[PENDING] 5r. Form Validation & Button State:** Disable the 'Generate DPP' button until all required fields (from core and sector schemas) are filled. Pause and allow the user to test and discuss next steps.
  - **[PENDING] 5s. Robust JSON Generation:** Ensure the 'Generate DPP' button correctly populates the output area with the full, valid JSON. Pause and allow the user to test and discuss next steps.
  - **[COMPLETED] 5t. Refactor Battery Sector Data Model:** Corrected the data model for several battery sector properties that were incorrectly defined as objects, causing UI and validation failures.
    - **[COMPLETED] 5t-1. Diagnose Modeling Flaw:** Identified that properties like `nominalVoltage` were incorrectly modeled as `QuantitativeValue` objects instead of primitive types, causing a mismatch between the ontology, schema, and context.
    - **[COMPLETED] 5t-2. Refactor to Primitive Types:** Updated the ontology, JSON schema, and JSON-LD context to define `nominalVoltage`, `ratedCapacity`, and `stateOfHealth` as simple `xsd:decimal` / `number` types.
    - **[COMPLETED] 5t-3. Fix Example Data and Validation:** Corrected the `battery-dpp-v1.json` example data and the corresponding SHACL shapes to align with the new primitive data model, allowing all tests to pass.
    - **[COMPLETED] 5t-4. Fix `batteryCarbonFootprint` UI:** Correctly defined the sub-properties of `batteryCarbonFootprint` in the JSON schema, allowing the form builder to render its fields instead of `[object]`, and aligned its units with the EPD ontology.
