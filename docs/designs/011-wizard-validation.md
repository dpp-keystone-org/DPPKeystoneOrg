# Design Doc 011: DPP Wizard Validation

This document outlines the sub-roadmap for Task #5y, implementing real-time input validation in the DPP Wizard.

---

- **[COMPLETED] 5y. Add format validation to the wizard:** Implement real-time validation for various formats and constraints defined in the JSON schemas and ontologies.
  - **[COMPLETED] 5y-1. [Test] Add Failing Test for URI Format:** In `testing/unit/wizard.test.js`, add a test for a field with `format: "uri"`. Programmatically set an invalid value (e.g., "not a url") and assert that the input receives an `.invalid` class and an associated error message appears. This test will fail.
  - **[COMPLETED] 5y-2. [Implementation] Create Validator Module & URI Logic:** Create `src/wizard/validator.js`. Add an `isURI()` function. In `form-builder.js`, add an `input` event listener to URI fields that calls `isURI()`, toggles the `.invalid` class, and displays/hides the error message. This should make the test pass.
  - **[COMPLETED] 5y-3. [Test] Add Failing Test for Date Input Type:** In `testing/unit/wizard.test.js`, add a test to assert that a schema property with `format: "date"` results in an `<input type="date">`. This test will fail.
  - **[COMPLETED] 5y-4. [Implementation] Use Native Date Inputs:** In `form-builder.js`, modify the input creation logic to set `input.type = 'date'` for properties with `format: "date"` and `input.type = 'datetime-local'` for `format: "date-time"`. This should make the test pass.
  - **[COMPLETED] 5y-5. [Test] Add Failing Test for Numeric Range:** In `testing/unit/wizard.test.js`, test a numeric field against a mock ontology with `min` and `max` validation properties. Set its value to an out-of-range number and assert that it becomes invalid. This test will fail.
  - **[COMPLETED] 5y-6. [Implementation] Implement Generic Numeric Range Validation:** In `form-builder.js`, enhance the validation handler to check for `ontologyInfo.validation.min/max` and apply the range check. This makes the test pass without hard-coding paths.
  - **[COMPLETED] 5y-7. [Test] Add Failing Test for Country Code:** In `testing/unit/wizard.test.js`, add a test for the `countryOfOrigin` field. Set its value to an invalid code and assert that the field becomes invalid. This test will fail.
  - **[COMPLETED] 5y-8. [Implementation] Implement Country Code (alpha-3) Validation:** In `validator.js`, add an `isCountryCodeAlpha3()` function. In `form-builder.js`, update the validation handler to use this function for relevant fields. This should make the test pass.
  - **[COMPLETED] 5y-8b. [Test & Impl] Add Basic Type Validation:** The logic to check primitive types (`isNumber`, `isInteger`) is implemented in `validator.js` and `form-builder.js`. This is now tested via a Playwright integration test that correctly simulates browser behavior.
  - **[COMPLETED] 5y-8c. [Test & Impl] Add `required` field Validation:** The logic to check for empty required fields is implemented in `form-builder.js`. The initial state is now tested via a Playwright integration test.
  - **[COMPLETED] 5y-9. [Test] Add Failing Test for Button State:** In `testing/integration/playwright/wizard.spec.js`, create a test that enters invalid data, asserts the "Generate DPP" button is disabled, corrects the data, and asserts the button is enabled.
  - **[COMPLETED] 5y-10. [Implementation] Implement Global Validity & Button State:** In `wizard.js`, track the validity of all fields and update the "Generate DPP" button's `disabled` property based on this global state. This makes the integration test pass.
  - **[COMPLETED] [SUB-TASK] Test Infrastructure for Form Population:** Before implementing more complex validation tests, we will build a schema-aware helper to automatically populate form fields. This makes tests cleaner, more resilient, and unblocks further validation work.
    - **[COMPLETED] 5y-11. [Implementation] Expose Schema Data for Testing:** In `src/wizard/wizard.js`, expose the loaded schemas to the `window` object in a test environment to make them accessible to Playwright tests.
    - **[COMPLETED] 5y-12. [Test] Add Failing Unit Test for Data Generator:** In a new file, `testing/unit/test-helpers.test.js`, write a failing test that calls a (not-yet-existent) `generateRequiredFieldData` function with a mock schema and asserts the output.
    - **[COMPLETED] 5y-13. [Implementation] Create Data Generator:** In `testing/integration/test-helpers.mjs`, implement the `generateRequiredFieldData` function to recursively generate valid data for all required fields in a schema. This will make the test from `5y-12` pass.
    - **[COMPLETED] 5y-14. [Implementation] Create Playwright Helper:** In `testing/integration/test-helpers.mjs`, create an `async` `fillRequiredFields(page, schema)` helper that uses the data generator to populate the wizard form.
    - **[COMPLETED] 5y-15. [Test] Use Helper in Playwright Test:** In `testing/integration/playwright/wizard.spec.js`, refactor an existing test to use the new `fillRequiredFields` helper, removing manual data entry and confirming the test still passes. This serves as the integration test for the helper.
  - **[SUB-TASK] Validation UI and Finalization**
    - **[COMPLETED] 5y-16. [Test & Impl] Add Initial State Validation:** Add a Playwright test to assert that on initial load, the "Generate" button is disabled due to empty required fields. Implement logic to validate the initial state.
    - **[COMPLETED] 5y-17. [Cleanup] Refactor and Consolidate:** Review the validation logic in `form-builder.js` and `validator.js` for clarity, consistency, and opportunities for consolidation.
        - **[COMPLETED] 5y-17a. [Refactor] Consolidate Array Handling in `form-builder.js`:** The `renderArrayProperty` function has significant code duplication for handling "add" and "remove" logic between simple arrays and object arrays. Refactor this by creating shared helper functions for item creation, removal, and re-indexing to reduce complexity and improve maintainability.
        - **[COMPLETED] 5y-17b. [Review] `validator.js`:** The `validator.js` module consists of simple, pure functions and does not require significant refactoring at this time.
    - **[COMPLETED] 5y-18. [UX/UI] Design a Global Error Indicator:** Instead of just disabling the "Generate DPP" button, display a "Show Errors" button with a badge showing the error count.
    - **[COMPLETED] 5y-19. [Test] Add Failing Test for Error Modal:** In `testing/integration/playwright/wizard.spec.js`, add a test that clicks the "Show Errors" button and asserts that a modal appears containing a link to the invalid field.
    - **[COMPLETED] 5y-20. [Implementation] Implement Error Modal:** In `wizard.js`, implement the "Show Errors" modal.
    - **[COMPLETED] 5y-21. [Cleanup] Finalize UI and Styling:** Add necessary CSS in `wizard.css` to style the new UI components.
    - **[COMPLETED] 5y-22. [Test & Impl] Validate on Blur/Change Events:** The validation logic now fires on `blur` for text inputs and `change` for select inputs, improving user experience and aligning with web standards. All related unit and integration tests were updated and are passing.
    - **[COMPLETED] 5y-23. [Test & Impl] Add Ontology-Based Type Validation:** The `ontology-loader.js` now parses `rdfs:range` to determine a property's data type (e.g., `xsd:decimal`). The validation logic in `form-builder.js` uses this information to perform correct type checking, catching mismatches between schema type (`string`) and ontology type (`decimal`).
    - **[COMPLETED] 5y-24. [Bugfix] Fix Stale and Duplicate Validation Messages:** Correct the UI behavior where validation error messages do not disappear after a field becomes valid, and where duplicate messages can appear.
        - **[COMPLETED] 5y-24a. [Test] Add Failing Test for Stale Message:** In `testing/integration/playwright/wizard.spec.js`, create a new test. It should enter an invalid value into a field, assert the error message span appears, then enter a valid value and assert that the error message span is removed from the DOM.
        - **[COMPLETED] 5y-24b. [Implementation] Correct Error Span Handling:** In `form-builder.js`, investigate and fix the logic inside `handleValidation` that finds and removes the `.error-message` span. Ensure the `querySelector` correctly identifies the existing span and that `errorSpan.remove()` is effective. This should fix both the stale and duplicate message issues.
  - **[COMPLETED] 5z. [Feature] Conditional Validation for Optional Objects:** Implement a mechanism to handle "optional objects" (like EPD) that contain their own required fields. The required fields within such an object should only be enforced if the user chooses to include the object.
    - **[COMPLETED] 5z-a. [Test] Add Failing Unit Test for UI Scaffolding:** In `testing/unit/wizard.test.js`, wrote a failing test that mocked a schema with an optional object and asserted that its fields were not rendered by default, but a placeholder "Add" button was.
    - **[COMPLETED] 5z-b. [Implementation] Implement UI Scaffolding:** In `form-builder.js`, modified the logic to not render fields for optional objects by default. This made the test from `5z-a` pass after fixing related test regressions.
    - **[COMPLETED] 5z-c. [Test] Add Failing Unit Test for "Add" Functionality:** In `testing/unit/wizard.test.js`, add a test that clicks the "Add" button for an optional object. Assert that the object's fields are rendered and the button is replaced by a "Remove" button.
    - **[COMPLETED] 5z-d. [Implementation] Implement "Add" Functionality:** In `form-builder.js`, add the event listener and rendering logic to make the test from `5z-c` pass.
    - **[COMPLETED] 5z-e. [Test] Add Failing Unit Test for "Remove" Functionality:** In `testing/unit/wizard.test.js`, add a test that clicks the "Remove" button. Assert that the fields are removed and the button reverts to "Add".
    - **[COMPLETED] 5z-f. [Implementation] Implement "Remove" Functionality:** In `form-builder.js`, add the removal logic to make the test from `5z-e` pass.
    - **[COMPLETED] 5z-g. [Test] Add Failing Test for Conditional Validation on "Add":** Write a new failing Playwright test. It will assert the initial error count. Then, click "Add EPD" and assert that the global error count increases because the newly-visible required fields inside `epd` are empty.
    - **[COMPLETED] 5z-h. [Implementation] Implement Conditional Validation on "Add":** Implement state tracking in `wizard.js` and update the `handleValidation` logic in `form-builder.js` to make the `isRequired` check conditional on whether the optional object has been added. This will make the test from `5z-g` pass.
    - **[COMPLETED] 5z-i. [Test] Add Failing Test for Conditional Validation on "Remove":** Extend the validation test. After adding the object and seeing the new errors, click "Remove EPD". Assert that the error count returns to its original value.
    - **[COMPLETED] 5z-j. [Implementation] Implement Conditional Validation on "Remove":** Ensure the removal logic also correctly updates the global validation state, making the test from `5z-i` pass.
    - **[COMPLETED] 5z-k. [Bugfix] Display Optional Object Label on "Add" Button Row:** When the "Add OBJECTNAME" button is visible, the label of the object is not shown in the 4th column.
        - **[COMPLETED] 5z-k.1. [Test] Add Failing Unit Test for Optional Object Label:** In `testing/unit/wizard.js`, add a test that asserts that when an optional object's "Add" button is visible, the 4th column (Ontology) of that row displays the object's label (from `ontologyMap`). This test should fail.
        - **[COMPLETED] 5z-k.2. [Implementation] Display Optional Object Label:** In `form-builder.js`, modify `renderObjectProperty` to ensure the label for the optional object is displayed in the Ontology column of the placeholder row. This should make the test pass.
    - **[COMPLETED] 5z-l. [Bugfix] Preserve Optional Object Root Row After "Add":** When an optional object is added, its root row disappears from the form, leaving the object fields without context.
        - **[COMPLETED] 5z-l.1. [Test] Add Failing Unit Test for Optional Object Root Row Persistence:** In `testing/unit/wizard.test.js`, add a test that clicks the "Add" button for an optional object and asserts that the original row (containing the "Add" button, now potentially transformed) remains in the DOM, perhaps with a different appearance or content, but still providing context. This test should fail.
        - **[COMPLETED] 5z-l.2. [Implementation] Preserve Optional Object Root Row:** In `form-builder.js`, modify `renderObjectProperty` and the "Add" button's event listener to ensure the original placeholder row is transformed (e.g., its content changes to a header) rather than being completely replaced, thus maintaining its presence and providing context. This should make the test pass.
    - **[COMPLETED] 5z-m. [Bugfix] Fix Optional Object Button Label:** The "Add" and "Remove" buttons for optional objects now display a generic label ("Add" / "Remove") for UI consistency.
    - **[COMPLETED] 5z-n. [Test] Add Test Variants for Expanded Optional Objects:** After the Add/Remove functionality is complete, create variants of existing unit tests (e.g., for nested field paths, ontology inheritance) that specifically test the behavior of dynamically expanded optional objects to ensure they match the behavior of required objects.
        - **[COMPLETED] 5z-n.1. [Implementation] Support 'Source' Annotation:** Update ontology loader and form builder to extract and display `dcterms:source` in tooltips.
        - **[COMPLETED] 5z-n.2. [Implementation] Support Class-Based Inheritance:** Update form builder to inherit annotations (`unit`, `governedBy`, `source`) from the property's domain class if not present on the property itself.
        - **[COMPLETED] 5z-n.3. [Test] Verify Inheritance Precedence:** Add unit tests to verify the precedence order (Property > Class > Parent Property > Parent Class).
    - **[COMPLETED] 5z-o. [Test] Add Comprehensive Unit Tests for Optional Object Edge Cases:** Add a suite of unit tests in `wizard.test.js` to cover complex scenarios and edge cases for the Add/Remove functionality.
        - **[COMPLETED] 5z-o.1. [Implementation] Add Edge Case Tests:** Implement tests for nested optional objects, sibling optional objects, and data persistence/clearing upon removal and re-addition.