# Design Doc 005: DPP Wizard MVP

This document outlines the sub-roadmap for Task #5, the development of a client-side web-based wizard to generate a valid DPP JSON file.

---

- **[COMPLETED] 5. DPP Wizard MVP:** Develop a client-side web-based wizard to generate a valid DPP JSON file, serving as a proof-of-concept for stakeholders. Pause and allow the user to test and discuss next steps.
  - **[COMPLETED] 5a. Architecture & Setup:** Create `src/wizard/` containing `index.html`, `wizard.css`, and `wizard.js`. Configure `index.html` to link to the shared branding CSS at `../../branding/css/keystone-style.css`. Ensure the build process deploys this directory to `dist/spec/wizard/`.
  - **[COMPLETED] 5b. Sector Selection:** Implement UI in `index.html` and logic in `wizard.js` to handle sector selection.
  - **[COMPLETED] 5c. Dynamic Form Generation:** Create `src/wizard/schema-loader.js` to fetch JSON schemas from the relative path `../validation/v1/json-schema/`. Create `src/wizard/form-builder.js` to dynamically generate HTML form inputs based on the loaded schema definitions.
  - **[COMPLETED] 5d. Voluntary Information:** Implement logic in `wizard.js` to add dynamic name-value pair fields to the UI.
  - **[COMPLETED] 5e. JSON Generation:** Create `src/wizard/dpp-generator.js` to scrape the generated form data from the DOM and construct the final DPP JSON object.
  - **[COMPLETED] 5f. Unit Testing:** Create `testing/unit/wizard.test.js` using Jest and JSDOM. Test `form-builder.js` by passing mock schemas and asserting HTML output. Test `dpp-generator.js` by populating a virtual DOM and asserting the resulting JSON.
  - **[COMPLETED] 5g. Integration Testing:** Create `testing/integration/wizard-flow.test.js` to simulate a full user session. Mock the schema `fetch` calls, programmatically fill the virtual form, trigger generation, and validate the output JSON against the official `dpp.schema.json` using Ajv.
  - **[COMPLETED] 5h. Initial Core DPP Form:** On load, display a form for core DPP fields based on `dpp.schema.json`.
  - **[COMPLETED] 5i. Stabilize UI Test Runner:** Set up and stabilized the Playwright UI integration test runner, which was essential for debugging the form generation logic. This involved fixing timeouts and incorrect selectors in the spec files (`testing/integration/playwright/`) and ensuring the test commands in `testing/package.json` ran correctly.
  - **[COMPLETED] 5j. Improve Wizard UI Test Coverage:** Before implementing new features, increase the robustness and coverage of the Playwright UI tests to ensure the current form generation works correctly across all sectors. Pause and allow the user to test and discuss next steps.
    - **[COMPLETED] 5j-1. Consolidate and Parameterize Tests:** Refactor the two separate test files (`wizard.spec.js`, `wizard-construction.spec.js`) into a single `wizard.spec.js`. This test will be parameterized to loop through all available sectors: `['battery', 'construction', 'electronics', 'textile']`. Pause and allow the user to test and discuss next steps.
    - **[COMPLETED] 5j-2. Add Sector-Specific Assertions:** Within the parameterized test, add specific `expect` assertions to verify that a unique and representative field for each sector is correctly rendered. Pause and allow the user to test and discuss next steps.
    - **[COMPLETED] 5j-3. Add Sector Switching Stress Test:** Create a new test case that simulates a user selecting different sectors one after another to test for race conditions or state management issues ("flaky sector loading"). Pause and allow the user to test and discuss next steps.
  - **[COMPLETED] 5k. Fully Support Nested Object Display:** Debug the client-side `form-builder.js` to ensure that fully resolved nested objects (like EPD) are correctly rendered as dot-separated input fields in the browser, fixing the '[object]' UI bug.
  - **[COMPLETED] 5l. Display `rdfs:label` in Ontology Column:** Modify the form builder to display the `rdfs:label` from the ontology in the third column, providing a more human-readable name for each field. Pause and allow the user to test and discuss next steps.
  - **[COMPLETED] 5m. Refine Ontology Column UI:** Refactor the form builder to display the `rdfs:comment` in a tooltip icon in a new, fourth column.
    - **[COMPLETED] 5m-1. Update Unit Test:** In `testing/unit/wizard.test.js`, modify the assertions to expect a 4-column grid layout. The test will check for the tooltip button in the new fourth column and verify its `title` attribute contains the comment. This test will fail. Pause and allow the user to test and discuss next steps.
    - **[COMPLETED] 5m-2. Update CSS and Form Builder:** In `wizard.css`, change the grid to four columns and add styling for the tooltip button. In `form-builder.js`, update the logic to create the fourth column and place the styled tooltip button within it. This should make the unit test pass. Pause and allow the user to test and discuss next steps.
    - **[COMPLETED] 5m-3. Update Integration Test:** In `testing/integration/playwright/wizard.spec.js`, update the assertions to reflect the new 4-column structure, verifying the tooltip button and its content in a full browser environment. Pause and allow the user to test and discuss next steps.
  - **[COMPLETED] 5n. Improve Array UX:** Revisit and improve the user experience for array input fields based on user feedback.
    - **[COMPLETED] 5n-1. Add Failing Unit Test for Object Arrays:** In `testing/unit/wizard.test.js`, add a new test case with a schema containing an array of objects. Assert that clicking "Add" creates a nested sub-form, not a simple input. This test will fail. Pause and allow the user to test and discuss next steps.
    - **[CANCELLED] 5n-2. Implement Nested Array Logic:** In `form-builder.js`, refactor the array handler to detect when the `items` property is an object. It should then recursively call the `generateRows` function to build a sub-form for the object's properties. Also, wrap the array UI in a `<fieldset>` for better visual grouping. This should make the unit test pass. *(Note: The recursive generation was implemented, but the `<fieldset>` approach was superseded by a user-preferred lightweight layout that reused the main grid.)*
    - **[COMPLETED] 5n-3. Add Integration Test for Object Arrays:** In `testing/integration/playwright/wizard.spec.js`, update the test for the `battery` sector to assert that the complex `documents` array renders its nested fields correctly.
    - **[COMPLETED] 5n-4. Fix Add Button After Item Removal:** Test and fix the bug where the 'Add Item' button stops working after an array item has been deleted, due to an invalid DOM reference.
    - **[COMPLETED] 5n-5. Implement Re-indexing on Remove:** Test and implement the re-indexing of array items in the UI (e.g., changing `item.2` to `item.1`) when a preceding item is deleted. This ensures the final generated JSON does not have gaps in the array.
    - **[COMPLETED] 5n-6. Add Granular Tests for Array UX:** Added a comprehensive suite of unit tests to cover layout, addition, removal, and re-indexing for both primitive and object arrays to prevent regressions.
    - **[COMPLETED] 5n-7. Test Deeply Nested Arrays:** Added a unit test to verify that arrays within objects within arrays (a-in-o-in-a) render and re-index correctly.
    - **[COMPLETED] 5n-8. Fix Stale Remove Button Bug:** Fixed a bug where remove buttons on object array items would fail after a preceding item was removed and re-indexed, due to a stale closure in the event listener.
  - **[COMPLETED] 5o. Wizard Bug Bash:** Address a series of identified bugs and design gaps to improve wizard stability and correctness.
    - **See Design Doc:** [docs/designs/wizard-bug-bash.md](./wizard-bug-bash.md)
  - **[COMPLETED] 5p. Custom Field Implementation:** Implement a robust 'Add Custom Field' feature. This includes selecting data types (String, Number, Boolean), validating input formats, creating nested objects, and ensuring no namespace collisions with existing sector fields.
    - **See Design Doc:** [docs/designs/012-custom-fields.md](./012-custom-fields.md)
  - **[COMPLETED] 5r. Form Validation & Button State:** Disable the 'Generate DPP' button until all required fields (from core and sector schemas) are filled. Pause and allow the user to test and discuss next steps.
  - **[COMPLETED] 5s. Robust JSON Generation:** Ensure the 'Generate DPP' button correctly populates the output area with the full, valid JSON. This includes handling typed custom fields, nested groups, and multiple sectors.
    - **See Design Doc:** docs/designs/013-json-generation.md
  - **[COMPLETED] 5t. Refactor Battery Sector Data Model:** Corrected the data model for several battery sector properties that were incorrectly defined as objects, causing UI and validation failures.
    - **[COMPLETED] 5t-1. Diagnose Modeling Flaw:** Identified that properties like `nominalVoltage` were incorrectly modeled as `QuantitativeValue` objects instead of primitive types, causing a mismatch between the ontology, schema, and context.
    - **[COMPLETED] 5t-2. Refactor to Primitive Types:** Updated the ontology, JSON schema, and JSON-LD context to define `nominalVoltage`, `ratedCapacity`, and `stateOfHealth` as simple `xsd:decimal` / `number` types.
    - **[COMPLETED] 5t-3. Fix Example Data and Validation:** Corrected the `battery-dpp-v1.json` example data and the corresponding SHACL shapes to align with the new primitive data model, allowing all tests to pass.
    - **[COMPLETED] 5t-4. Fix `batteryCarbonFootprint` UI:** Correctly defined the sub-properties of `batteryCarbonFootprint` in the JSON schema, allowing the form builder to render its fields instead of `[object]`, and aligned its units with the EPD ontology.
  - **[COMPLETED] 5u. Support loading multiple sectors simultaneously without overlap:** Change how sector logic works, allowing addition of at most one instance of a sector per form, and removal of sectors from the form. Instead of data loss when switching sectors. Pause often and allow the user to test and discuss next steps.
    - **[COMPLETED] 5u-1. [Failing Test] Add/Remove Sector Forms:** Extend the Playwright test. After clicking "Add Battery Sector," assert that the battery form appears. Then, add a "Remove" button next to the sector form, click it, and assert the form is removed. This test will fail. Pause often and allow the user to test and discuss next steps.
    - **[COMPLETED] 5u-2. [Implementation] Implement Add/Remove Logic:** In `wizard.js`, implement event listeners for the "Add" and "Remove" sector buttons to render and remove the forms. Pause often and allow the user to test and discuss next steps.
    - **[COMPLETED] 5u-3. [Test] Prevent Duplicate Sectors:** Add a test to ensure the "Add" button is disabled or hidden after a sector has been added. Pause often and allow the user to test and discuss next steps.
    - **[COMPLETED] 5u-4. [Implementation] Disable Duplicate Sector Addition:** Implement the logic to disable the "Add" button for an already added sector. Pause often and allow the user to test and discuss next steps.
    - **[COMPLETED] 5u-5. [Refactor] Refactor UI Generation:** Refactor `wizard.js` and `form-builder.js` to manage multiple sector forms in the DOM, likely by creating container elements for each sector. Pause often and allow the user to test and discuss next steps.
    - **[COMPLETED] 5u-6. [Test] JSON Generation with Multiple Sectors:** Add an integration test that adds multiple sectors, populates data, and asserts the generated JSON contains data from all sectors. Pause often and allow the user to test and discuss next steps.
  - **[COMPLETED] 5v. Fix Tooltip:** The tooltips are great but won't be accessibility-safe. They don't increase font-size when the rest of the browser is zoomed in, so they need to be moved into a pop up window that also increases and decreases with zoom. Pause often and allow the user to test and discuss next steps.
  - [COMPLETED] 5w. Add a column for units to the wizard: Right now the user has to guess what is a valid unit or format. Add a column to display units, when they are described in the ontology, directly to the right of the data value column for better user context. Pause often and allow the user to test and discuss next steps.
    - [COMPLETED] 5w-1. [Failing Test] Update Unit Test for 5-Column Layout: Modify `testing/unit/wizard.test.js` to use a mock ontology with a `unit`. Assert that the generated form has a 5-column layout with the "Unit" column appearing after the "Value" column. This test will fail. Pause and allow the user to test and discuss next steps.
    - [COMPLETED] 5w-2. [Implementation] Extract Unit from Ontology: Investigate ontology files to find the unit property. Update `src/wizard/ontology-loader.js` to parse and store the unit in the `ontologyMap`. Pause and allow the user to test and discuss next steps.
    - [COMPLETED] 5w-3. [Implementation] Update Form Builder and CSS: Modify `src/wizard/form-builder.js` and `src/wizard/wizard.css` to create and style a 5-column grid in the new order: `Field Path | Value | Unit | Ontology | Tooltip`. This should make the unit test pass. Pause and allow the user to test and discuss next steps.
    - [COMPLETED] 5w-4. [Test] Update Integration Tests: Review and update any integration tests that are affected by the new 5-column layout. Pause and allow the user to test and discuss next steps.
  - **[COMPLETED] 5x. Add a language selector:** At the top of the page, decide on a good place to put a drop-down of supported languages. For now, all 24 EU languages should show in the drop down. When a label isn't available in a selected language, use the english one. Pause often and allow the user to test and discuss next steps.
    - [COMPLETED] 5x-1. [Test] Add Failing UI Test for Language Selector:** In `testing/integration/playwright/wizard.spec.js`, add a test that looks for a language selector dropdown that does not yet exist. This test will fail.
    - [COMPLETED] 5x-2. [Implementation] Add Language Selector UI:** In `src/wizard/index.html`, add the `<select>` element for the language dropdown, populated with the 24 EU languages. Style it in `src/wizard/wizard.css`. This should make the previous test pass.
    - [COMPLETED] 5x-3. [Test] Add Failing Test for Multi-Language Loading:** In `testing/unit/ontology-loader.test.js`, update the mock ontology to include multiple languages for a term. Assert that the `ontologyMap` stores the full language object (e.g., `{ en: 'Name', de: 'Name' }`), not just the English string. This test will fail.
    - [COMPLETED] 5x-4. [Implementation] Enhance Ontology Loader:** Modify `src/wizard/ontology-loader.js` to parse all available language translations for labels and comments, storing them as objects in the `ontologyMap`. This should make the previous test pass.
    - **[COMPLETED] 5x-5. [Test] Add Failing Test for Language Switching:** In `testing/integration/wizard-flow.test.js`, add a test that uses a multi-language mock ontology, simulates changing the language selector, and asserts that a field's label text does *not* change (as the logic is not yet implemented).
    - **[COMPLETED] 5x-6. [Implementation] Implement Language Switching Logic:** In `wizard.js`, add the event listener to the dropdown. In `form-builder.js`, modify the logic to accept the current language and display the correct translated text, with a fallback to English. This includes re-rendering the form on language change. This should make the previous test pass.
    - **[COMPLETED] 5x-7. [Test] Add Unit Test for Translated Tooltips:** In `testing/unit/wizard.test.js`, add a new test case that provides a mock ontology with a translated comment, renders the form in that language, and asserts that the tooltip modal contains the correct translated text.
    - **[COMPLETED] 5x-8. [Test] Expand Integration Test for Translated Tooltips:** In `testing/integration/wizard-flow.test.js`, expand the existing language switching test to also assert that the tooltip modal's content is correctly translated when the language is changed.
  - **[COMPLETED] 5y. Add format validation to the wizard:** Right now, the user can type anything into any of the fields in the wizard. We need to design and add validators for the different formats found in the JSON schema and often refined or specialized further in the ontology. This is a complex change.
    - **See Design Doc:** [docs/designs/011-wizard-validation.md](./011-wizard-validation.md)    - **[COMPLETED] 5z-o. [Test] Add Comprehensive Unit Tests for Optional Object Edge Cases:** Add a suite of unit tests in `wizard.test.js` to cover complex scenarios and edge cases for the Add/Remove functionality.
        - **[COMPLETED] 5z-o.1. [Implementation] Add Edge Case Tests:** Implement tests for nested optional objects, sibling optional objects, and data persistence/clearing upon removal and re-addition.
  - **[COMPLETED] 5aa. Shared Field Synchronization:** When multiple sectors are loaded, fields with the same name (e.g., `manufacturer`) must stay in sync. Typing in one should update the other to ensure data consistency.
    - **[COMPLETED] 5aa-1. [Test] Add Failing Playwright Test:** Create a test that loads two sectors with a shared field, types into one, and asserts the other updates.
    - **[COMPLETED] 5aa-2. [Implementation] Global Sync Listener:** Implement a global `input` listener in `wizard.js` that finds all inputs with the same `name` and updates them.
  - **[COMPLETED] 5bb. Form State Persistence:** Implement `localStorage` caching for the Core form and active Sectors so data is preserved on page refresh.

